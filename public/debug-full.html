<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¯Ø§Ù„Ø©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 40px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { color: #f0b90b; margin-bottom: 30px; }
        .result {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid #333;
        }
        button {
            background: #f0b90b;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #ffd000; }
        .success { color: #00ff00; }
        .error { color: #ff3333; }
        .info { color: #00aaff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ØªØ´Ø®ÙŠØµ Ù…ÙØµÙ„</h1>
        
        <button onclick="testEverything()">ğŸš€ Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„</button>
        
        <div id="output"></div>
    </div>

    <script>
        async function testEverything() {
            const output = document.getElementById('output');
            output.innerHTML = '';
            
            function log(message, type = 'info') {
                output.innerHTML += `<div class="result ${type}">${message}</div>`;
            }
            
            // Ø§Ù„Ø®Ø·ÙˆØ© 1: ÙØ­Øµ localStorage
            log('=== Ø§Ù„Ø®Ø·ÙˆØ© 1: ÙØ­Øµ localStorage ===', 'info');
            const stored = localStorage.getItem('binance_credentials');
            
            if (!stored) {
                log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ§ØªÙŠØ­ ÙÙŠ localStorage!', 'error');
                return;
            }
            
            log('âœ… ØªÙˆØ¬Ø¯ Ù…ÙØ§ØªÙŠØ­ ÙÙŠ localStorage', 'success');
            
            let credentials;
            try {
                credentials = JSON.parse(stored);
                log(`Ø§Ù„Ù…ÙØ§ØªÙŠØ­:\nAPI Key: ${credentials.apiKey}\nSecret Key: ${credentials.secretKey?.substring(0, 20)}...`, 'info');
            } catch (e) {
                log('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ JSON: ' + e.message, 'error');
                return;
            }
            
            // Ø§Ù„Ø®Ø·ÙˆØ© 2: ÙØ­Øµ ØµÙŠØºØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            log('\n=== Ø§Ù„Ø®Ø·ÙˆØ© 2: ÙØ­Øµ ØµÙŠØºØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===', 'info');
            
            if (!credentials.apiKey || !credentials.secretKey) {
                log('âŒ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ØºÙŠØ± ÙƒØ§Ù…Ù„Ø©!', 'error');
                log(`apiKey Ù…ÙˆØ¬ÙˆØ¯: ${!!credentials.apiKey}`, 'error');
                log(`secretKey Ù…ÙˆØ¬ÙˆØ¯: ${!!credentials.secretKey}`, 'error');
                return;
            }
            
            log('âœ… Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙƒØ§Ù…Ù„Ø©', 'success');
            
            // Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨
            log('\n=== Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ===', 'info');
            
            const requestBody = {
                apiKey: credentials.apiKey,
                secretKey: credentials.secretKey
            };
            
            log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©:\n' + JSON.stringify(requestBody, null, 2), 'info');
            
            try {
                log('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...', 'info');
                
                const response = await fetch('https://dpxuacnrncwyopehwxsj.supabase.co/functions/v1/binance-portfolio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                log(`\n=== Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ===`, 'info');
                log(`Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`Headers:\n${JSON.stringify([...response.headers.entries()], null, 2)}`, 'info');
                
                const responseText = await response.text();
                log(`\nResponse Body (raw):\n${responseText}`, 'info');
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    log(`\nResponse Body (parsed):\n${JSON.stringify(data, null, 2)}`, 'info');
                } catch (e) {
                    log('âš ï¸ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„ÙŠØ³Øª JSON ØµØ§Ù„Ø­', 'error');
                }
                
                if (!response.ok) {
                    log(`\nâŒ ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨!`, 'error');
                    if (data) {
                        log(`Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£: ${data.error || data.message || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}`, 'error');
                    }
                    return;
                }
                
                log('\n=== Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ===', 'success');
                
                if (data && data.balances) {
                    const usdtCoin = data.balances.find(b => b.asset === 'USDT');
                    const usdtBalance = usdtCoin ? parseFloat(usdtCoin.free).toFixed(2) : '0.00';
                    
                    log(`âœ… Ù†Ø¬Ø­!\n\nØ±ØµÙŠØ¯ USDT: ${usdtBalance}\nØ¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Øª: ${data.balances.length}\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©: $${parseFloat(data.totalValue || 0).toFixed(2)}`, 'success');
                    
                    log(`\nØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª:\n${data.balances.map(b => `${b.asset}: ${b.free}`).join('\n')}`, 'info');
                } else {
                    log('âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ balances', 'error');
                }
                
            } catch (error) {
                log(`\nâŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨:\n${error.message}\n${error.stack}`, 'error');
            }
        }
    </script>
</body>
</html>
